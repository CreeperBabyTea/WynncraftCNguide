import{a as y,T as b,l as v,p as w}from"../chunks/vidstack-284499df.js";import{L as c,k as E,g as T}from"../chunks/vidstack-fdaf7abf.js";import{VideoProvider as L}from"./vidstack-video.js";import{p,D as r,l as g,e as S,g as I,a as f,h as u,_ as x}from"../chunks/vidstack-f5f427f7.js";import{Q as k,c as C}from"../chunks/vidstack-4e718951.js";import{R as _}from"../chunks/vidstack-8cb01b64.js";const $=n=>I(n);class D{constructor(t){this.k=null,this.m=null,this.d={},this.e=new Set,this.n=t}get instance(){return this.k}setup(t,s){this.l=s;const i=p(s.$state.streamType).includes("live"),o=p(s.$state.streamType).includes("ll-");this.k=new t({lowLatencyMode:o,backBufferLength:o?4:i?8:void 0,renderTextTracksNatively:!1,...this.d});const e=this.o.bind(this);for(const a of Object.values(t.Events))this.k.on(a,e);this.k.on(t.Events.ERROR,this.p.bind(this));for(const a of this.e)a(this.k);s.player.dispatch(new r("hls-instance",{detail:this.k})),this.k.attachMedia(this.n),this.k.on(t.Events.AUDIO_TRACK_SWITCHED,this.q.bind(this)),this.k.on(t.Events.LEVEL_SWITCHED,this.r.bind(this)),this.k.on(t.Events.LEVEL_LOADED,this.s.bind(this)),this.k.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.t.bind(this)),this.k.on(t.Events.CUES_PARSED,this.u.bind(this)),s.qualities[k.v]=this.w.bind(this),g(s.qualities,"change",this.x.bind(this)),g(s.audioTracks,"change",this.y.bind(this)),this.m=S(this.z.bind(this))}z(){if(!this.l.$state.live())return;const t=new _(this.A.bind(this));return t.D(),t.E.bind(t)}A(){this.l.$state.liveSyncPosition.set(this.k?.liveSyncPosition??1/0)}o(t,s){this.l.player?.dispatch(new r($(t),{detail:s}))}t(t,s){const i=new r(t,{detail:s});let o=-1;for(let e=0;e<s.tracks.length;e++){const a=s.tracks[e],h=a.subtitleTrack??a.closedCaptions,d=new y({id:`hls-${a.kind}${e}`,src:h?.url,label:a.label,language:h?.lang,kind:a.kind});d[b.F]=2,d[b.G]=()=>{d.mode==="showing"?(this.k.subtitleTrack=e,o=e):o===e&&(this.k.subtitleTrack=-1,o=-1)},a.default&&d.setMode("showing",i),this.l.textTracks.add(d,i)}}u(t,s){const i=this.l.textTracks.getById(`hls-${s.track}`);if(!i)return;const o=new r(t,{detail:s});for(const e of s.cues)e.positionAlign="auto",i.addCue(e,o)}q(t,s){const i=this.l.audioTracks[s.id];i&&this.l.audioTracks[c.B](i,!0,new r(t,{detail:s}))}r(t,s){const i=this.l.qualities[s.level];i&&this.l.qualities[c.B](i,!0,new r(t,{detail:s}))}s(t,s){if(this.l.$state.canPlay())return;const{type:i,live:o,totalduration:e,targetduration:a}=s.details,h=new r(t,{detail:s});this.l.delegate.f("stream-type-change",{detail:o?i==="EVENT"&&Number.isFinite(e)&&a>=10?"live:dvr":"live":"on-demand",trigger:h}),this.l.delegate.f("duration-change",{detail:e,trigger:h});const d=this.k.media;this.k.currentLevel===-1&&this.l.qualities[k.H](!0,h);for(const l of this.k.audioTracks)this.l.audioTracks[c.C]({id:l.id+"",label:l.name,language:l.lang||"",kind:"main"},h);for(const l of this.k.levels)this.l.qualities[c.C]({width:l.width,height:l.height,codec:l.codecSet,bitrate:l.bitrate},h);d.dispatchEvent(new r("canplay",{trigger:h}))}p(t,s){if(s.fatal)switch(s.type){case"networkError":this.k?.startLoad();break;case"mediaError":this.k?.recoverMediaError();break;default:this.k?.destroy(),this.k=null;break}}w(){this.k&&(this.k.currentLevel=-1)}x(){const{qualities:t}=this.l;!this.k||t.auto||(this.k[t.switch+"Level"]=t.selectedIndex,E&&(this.n.currentTime=this.n.currentTime))}y(){const{audioTracks:t}=this.l;this.k&&this.k.audioTrack!==t.selectedIndex&&(this.k.audioTrack=t.selectedIndex)}i(){this.l&&(this.l.qualities[k.v]=void 0),this.k?.destroy(),this.k=null,this.m?.(),this.m=null}}class H{constructor(t,s,i){this.I=t,this.l=s,this.N=i,this.J()}async J(){const t={onLoadStart:this.K.bind(this),onLoaded:this.L.bind(this),onLoadError:this.M.bind(this)};let s=await q(this.I,t);if(f(s)&&!u(this.I)&&(s=await R(this.I,t)),!s)return null;if(!s.isSupported()){const i="[vidstack]: `hls.js` is not supported in this environment";return this.l.player.dispatch(new r("hls-unsupported")),this.l.delegate.f("error",{detail:{message:i,code:4}}),null}return s}K(){this.l.player.dispatch(new r("hls-lib-load-start"))}L(t){this.l.player.dispatch(new r("hls-lib-loaded",{detail:t})),this.N(t)}M(t){const s=C(t);this.l.player.dispatch(new r("hls-lib-load-error",{detail:s})),this.l.delegate.f("error",{detail:{message:s.message,code:4}})}}async function R(n,t={}){if(!f(n)){if(t.onLoadStart?.(),n.prototype&&n.prototype!==Function)return t.onLoaded?.(n),n;try{const s=(await n())?.default;if(s&&s.isSupported)t.onLoaded?.(s);else throw Error("");return s}catch(s){t.onLoadError?.(s)}}}async function q(n,t={}){if(u(n)){t.onLoadStart?.();try{if(await v(n),!x(window.Hls))throw Error("");const s=window.Hls;return t.onLoaded?.(s),s}catch(s){t.onLoadError?.(s)}}}const A="https://cdn.jsdelivr.net";class m extends L{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.c=null,this.a=new D(this.video),this.b=`${A}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.c}get instance(){return this.a.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.a.d}set config(t){this.a.d=t}get library(){return this.b}set library(t){this.b=t}preconnect(){u(this.b)&&w(this.b)}setup(t){super.setup(t),new H(this.b,t,s=>{this.c=s,this.a.setup(s,t),t.delegate.f("provider-setup",{detail:this});const i=p(t.$state.source);i&&this.loadSource(i)})}async loadSource(t,s){u(t.src)&&(this.g.preload=s||"",this.a.instance?.loadSource(t.src),this.h=t)}onInstance(t){const s=this.a.instance;return s&&t(s),this.a.e.add(t),()=>this.a.e.delete(t)}destroy(){this.a.i()}}m.supported=T();export{m as HLSProvider};
